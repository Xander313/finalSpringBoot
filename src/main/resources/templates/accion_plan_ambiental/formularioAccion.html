<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{base :: layout(~{::title}, ~{::section}, ~{::style}, ~{::script})}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${accion.codigoAccion} ? 'Editar Accion' : 'Nueva Accion'">Formulario Accion</title>

  <style>
    .form-shell {
      max-width: 1150px;
      margin: 0 auto;
    }

    .actions-wrap {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .field-error {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: #dc3545;
    }

    .timestamp-box {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
      padding: 12px 14px;
      font-size: 13px;
      color: #495057;
    }

    #accion-form .form-group label {
      display: block;
    }

    #accion-form .form-group .nice-select {
      float: none;
      width: 100%;
    }

    #accion-form .form-group .nice-select.is-invalid {
      border-color: #dc3545 !important;
    }

    #accion-form input[type="color"].is-invalid {
      border-color: #dc3545;
    }
  </style>
</head>
<body>
<section>
  <div class="row mt-3">
    <div class="col-lg-12 form-shell">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="card-title mb-0"
                 th:text="${accion.codigoAccion} ? 'Editar Accion del Plan Ambiental' : 'Nueva Accion del Plan Ambiental'">
              Nueva Accion del Plan Ambiental
            </div>
            <a th:href="@{/acciones-plan-ambiental}" class="btn btn-secondary btn-sm">
              <i class="fa-solid fa-arrow-left mr-1"></i> Volver
            </a>
          </div>
          <hr>

          <form id="accion-form" th:action="@{/acciones-plan-ambiental/guardar}" th:object="${accion}" method="post" novalidate>
            <input type="hidden" th:field="*{codigoAccion}">

            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="seccionId">Seccion del plan *</label>
                  <select id="seccionId" name="seccionId" class="form-control form-control-rounded" required>
                    <option value="">Seleccione seccion</option>
                    <option th:each="seccion : ${secciones}"
                            th:value="${seccion.codigoSeccion}"
                            th:text="${seccion.numeroSeccion + ' - ' + seccion.tituloSeccion}"
                            th:selected="${accion.seccionPlanAmbiental != null and accion.seccionPlanAmbiental.codigoSeccion == seccion.codigoSeccion}">
                    </option>
                  </select>
                </div>
              </div>

              <div class="col-md-3">
                <div class="form-group">
                  <label for="estadoAplica">Estado aplica *</label>
                  <select class="form-control form-control-rounded" id="estadoAplica" th:field="*{estadoAplica}" required>
                    <option value="">Seleccione estado</option>
                    <option value="1">APLICA</option>
                    <option value="0">NO APLICA</option>
                  </select>
                </div>
              </div>

              <div class="col-md-3">
                <div class="form-group">
                  <label for="colorAccionPicker">Color de la accion *</label>
                  <input type="color" class="form-control form-control-rounded p-1" id="colorAccionPicker" value="#abb1a9" required>
                  <input type="hidden" th:field="*{colorAccion}" id="colorAccion">
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label for="indicadorPlaceholderAccion">Indicador *</label>
                  <input type="text" class="form-control form-control-rounded" id="indicadorPlaceholderAccion"
                         th:field="*{indicadorPlaceholderAccion}" maxlength="100" placeholder="Indicador de la accion" required>
                </div>
              </div>

              <div class="col-md-3">
                <div class="form-group">
                  <label for="numeradorValorAccion">Numerador *</label>
                  <input type="number" class="form-control form-control-rounded" id="numeradorValorAccion"
                         th:field="*{numeradorValorAccion}" min="0" max="100" step="1" placeholder="0 a 100" required>
                </div>
              </div>

              <div class="col-md-3">
                <div class="form-group">
                  <label for="denominadorValorAccion">Denominador *</label>
                  <input type="number" class="form-control form-control-rounded" id="denominadorValorAccion"
                         th:field="*{denominadorValorAccion}" min="0" max="100" step="1" placeholder="0 a 100" required>
                </div>
              </div>

              <div class="col-md-4">
                <div class="form-group">
                  <label for="valorAccion">Valor de la accion *</label>
                  <input type="number" class="form-control form-control-rounded" id="valorAccion"
                         th:field="*{valorAccion}" min="0" max="100" step="0.01" placeholder="0 a 100" required>
                </div>
              </div>

              <div class="col-md-4">
                <div class="form-group">
                  <label for="frecuenciaAccion">Frecuencia *</label>
                  <input type="number" class="form-control form-control-rounded" id="frecuenciaAccion"
                         th:field="*{frecuenciaAccion}" min="0" max="10" step="1" placeholder="0 a 10" required>
                </div>
              </div>

              <div class="col-md-4">
                <div class="form-group">
                  <label for="periodoAccion">Periodo *</label>
                  <select class="form-control form-control-rounded" id="periodoAccion" th:field="*{periodoAccion}" required>
                    <option value="">Seleccione periodo</option>
                    <option value="DIARIO">DIARIO</option>
                    <option value="SEMANAL">SEMANAL</option>
                    <option value="QUINCENAL">QUINCENAL</option>
                    <option value="MENSUAL">MENSUAL</option>
                    <option value="TRIMESTRAL">TRIMESTRAL</option>
                    <option value="SEMESTRAL">SEMESTRAL</option>
                    <option value="ANUAL">ANUAL</option>
                  </select>
                </div>
              </div>

              <div class="col-12">
                <div class="form-group">
                  <label for="aspectoAmbientalAccion">Aspecto ambiental *</label>
                  <textarea class="form-control" id="aspectoAmbientalAccion" rows="4"
                            th:field="*{aspectoAmbientalAccion}" placeholder="Aspecto ambiental de la accion" required></textarea>
                </div>
              </div>

              <div class="col-12">
                <div class="form-group">
                  <label for="impactoAmbientalAccion">Impacto ambiental *</label>
                  <textarea class="form-control" id="impactoAmbientalAccion" rows="4"
                            th:field="*{impactoAmbientalAccion}" placeholder="Impacto ambiental de la accion" required></textarea>
                </div>
              </div>

              <div class="col-12">
                <div class="form-group">
                  <label for="medidasPropuestasAccion">Medidas propuestas *</label>
                  <textarea class="form-control" id="medidasPropuestasAccion" rows="4"
                            th:field="*{medidasPropuestasAccion}" placeholder="Medidas propuestas de la accion" required></textarea>
                </div>
              </div>

              <div class="col-md-6" th:if="${accion.fechaCreadoAccion != null}">
                <div class="form-group">
                  <label>Fecha de creacion</label>
                  <div class="timestamp-box" th:text="${#temporals.format(accion.fechaCreadoAccion, 'yyyy-MM-dd HH:mm:ss')}"></div>
                </div>
              </div>

              <div class="col-md-6" th:if="${accion.fechaEditadoAccion != null}">
                <div class="form-group">
                  <label>Fecha de ultima edicion</label>
                  <div class="timestamp-box" th:text="${#temporals.format(accion.fechaEditadoAccion, 'yyyy-MM-dd HH:mm:ss')}"></div>
                </div>
              </div>

              <div class="col-12">
                <div class="form-group mb-0 actions-wrap">
                  <a class="btn btn-secondary px-5" th:href="@{/acciones-plan-ambiental}">
                    <i class="fa-solid fa-xmark mr-1"></i> Cancelar
                  </a>
                  <button type="submit" class="btn btn-success px-5">
                    <i class="fa-solid fa-floppy-disk mr-1"></i> Guardar
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/localization/messages_es.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var colorPicker = document.getElementById('colorAccionPicker');
    var colorHidden = document.getElementById('colorAccion');
    var defaultAlpha = 0.2;

    var hexToRgba = function (hex, alpha) {
      if (!hex) {
        return '';
      }

      var normalized = hex.replace('#', '');
      if (normalized.length === 3) {
        normalized = normalized.split('').map(function (c) {
          return c + c;
        }).join('');
      }

      if (normalized.length !== 6) {
        return '';
      }

      var r = parseInt(normalized.substring(0, 2), 16);
      var g = parseInt(normalized.substring(2, 4), 16);
      var b = parseInt(normalized.substring(4, 6), 16);
      return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
    };

    var rgbaToHex = function (rgba) {
      if (!rgba) {
        return null;
      }

      var match = rgba.match(/rgba?\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})/i);
      if (!match) {
        return null;
      }

      var toHex = function (value) {
        var intValue = Math.max(0, Math.min(255, parseInt(value, 10)));
        return intValue.toString(16).padStart(2, '0');
      };

      return '#' + toHex(match[1]) + toHex(match[2]) + toHex(match[3]);
    };

    var syncColorRgba = function () {
      if (!colorPicker || !colorHidden) {
        return;
      }
      colorHidden.value = hexToRgba(colorPicker.value, defaultAlpha);
    };

    if (colorPicker && colorHidden) {
      if (colorHidden.value) {
        if (colorHidden.value.startsWith('rgba') || colorHidden.value.startsWith('rgb')) {
          var fromRgba = rgbaToHex(colorHidden.value);
          if (fromRgba) {
            colorPicker.value = fromRgba;
          }
        } else if (colorHidden.value.startsWith('#')) {
          colorPicker.value = colorHidden.value;
        }
      }

      syncColorRgba();
      colorPicker.addEventListener('input', syncColorRgba);
      colorPicker.addEventListener('change', syncColorRgba);
    }

    if (window.jQuery && $.fn.validate) {
      var trimValue = function (value) {
        return $.trim(value);
      };

      $('#accion-form').validate({
        ignore: [],
        rules: {
          seccionId: {
            required: true
          },
          estadoAplica: {
            required: true
          },
          colorAccion: {
            required: true
          },
          indicadorPlaceholderAccion: {
            required: true,
            minlength: 3,
            maxlength: 100,
            normalizer: trimValue
          },
          aspectoAmbientalAccion: {
            required: true,
            minlength: 3,
            normalizer: trimValue
          },
          impactoAmbientalAccion: {
            required: true,
            minlength: 3,
            normalizer: trimValue
          },
          medidasPropuestasAccion: {
            required: true,
            minlength: 3,
            normalizer: trimValue
          },
          numeradorValorAccion: {
            required: true,
            digits: true,
            min: 0,
            max: 100
          },
          denominadorValorAccion: {
            required: true,
            digits: true,
            min: 0,
            max: 100
          },
          valorAccion: {
            required: true,
            number: true,
            min: 0,
            max: 100,
            normalizer: trimValue
          },
          frecuenciaAccion: {
            required: true,
            digits: true,
            min: 0,
            max: 10
          },
          periodoAccion: {
            required: true,
            normalizer: trimValue
          }
        },
        messages: {
          seccionId: {
            required: 'Seleccione una seccion'
          },
          estadoAplica: {
            required: 'Seleccione el estado'
          },
          colorAccion: {
            required: 'Seleccione un color'
          },
          indicadorPlaceholderAccion: {
            required: 'Ingrese el indicador',
            minlength: 'Minimo 3 caracteres',
            maxlength: 'Maximo 100 caracteres'
          },
          aspectoAmbientalAccion: {
            required: 'Ingrese el aspecto ambiental',
            minlength: 'Minimo 3 caracteres'
          },
          impactoAmbientalAccion: {
            required: 'Ingrese el impacto ambiental',
            minlength: 'Minimo 3 caracteres'
          },
          medidasPropuestasAccion: {
            required: 'Ingrese las medidas propuestas',
            minlength: 'Minimo 3 caracteres'
          },
          numeradorValorAccion: {
            required: 'Ingrese el numerador',
            digits: 'Ingrese solo numeros',
            min: 'El numerador debe ser mayor o igual a 0',
            max: 'El numerador debe ser menor o igual a 100'
          },
          denominadorValorAccion: {
            required: 'Ingrese el denominador',
            digits: 'Ingrese solo numeros',
            min: 'El denominador debe ser mayor o igual a 0',
            max: 'El denominador debe ser menor o igual a 100'
          },
          valorAccion: {
            required: 'Ingrese el valor de la accion',
            number: 'Ingrese un valor numerico valido',
            min: 'El valor de la accion debe ser mayor o igual a 0',
            max: 'El valor de la accion debe ser menor o igual a 100'
          },
          frecuenciaAccion: {
            required: 'Ingrese la frecuencia',
            digits: 'Ingrese solo numeros',
            min: 'La frecuencia debe ser mayor o igual a 0',
            max: 'La frecuencia debe ser menor o igual a 10'
          },
          periodoAccion: {
            required: 'Seleccione el periodo'
          }
        },
        errorElement: 'small',
        errorClass: 'field-error',
        errorPlacement: function (error, element) {
          if (element.is('select') && element.next('.nice-select').length) {
            error.insertAfter(element.next('.nice-select'));
            return;
          }

          if (element.attr('id') === 'colorAccion') {
            error.insertAfter('#colorAccionPicker');
            return;
          }

          error.insertAfter(element);
        },
        highlight: function (element) {
          var $element = $(element);
          $element.addClass('is-invalid');

          if ($element.is('select') && $element.next('.nice-select').length) {
            $element.next('.nice-select').addClass('is-invalid');
          }

          if ($element.attr('id') === 'colorAccion') {
            $('#colorAccionPicker').addClass('is-invalid');
          }
        },
        unhighlight: function (element) {
          var $element = $(element);
          $element.removeClass('is-invalid');

          if ($element.is('select') && $element.next('.nice-select').length) {
            $element.next('.nice-select').removeClass('is-invalid');
          }

          if ($element.attr('id') === 'colorAccion') {
            $('#colorAccionPicker').removeClass('is-invalid');
          }
        }
      });
    }
  });
</script>
</body>
</html>
