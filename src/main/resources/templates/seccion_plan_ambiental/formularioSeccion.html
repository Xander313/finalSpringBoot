<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{base :: layout(~{::title}, ~{::section}, ~{::style}, ~{::script})}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${seccion.codigoSeccion} ? 'Editar Seccion' : 'Nueva Seccion'">Formulario Seccion</title>

  <style>
    .form-shell {
      max-width: 1100px;
      margin: 0 auto;
    }

    .actions-wrap {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .field-error {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: #dc3545;
    }

    .timestamp-box {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 0.75rem;
      padding: 12px 14px;
      font-size: 13px;
      color: #495057;
    }

    #seccion-form .form-group label {
      display: block;
    }

    #seccion-form .form-group .nice-select {
      float: none;
      width: 100%;
    }

    #seccion-form .form-group .nice-select.is-invalid {
      border-color: #dc3545 !important;
    }

    #seccion-form .nice-select .list {
      max-height: 280px;
      overflow-y: auto;
      overflow-x: hidden;
    }
  </style>
</head>
<body>
<section>
  <div class="row mt-3">
    <div class="col-lg-12 form-shell">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="card-title mb-0"
                 th:text="${seccion.codigoSeccion} ? 'Editar Seccion del Plan Ambiental' : 'Nueva Seccion del Plan Ambiental'">
              Nueva Seccion del Plan Ambiental
            </div>
            <a th:href="@{/secciones-plan-ambiental}" class="btn btn-secondary btn-sm">
              <i class="fa-solid fa-arrow-left mr-1"></i> Volver
            </a>
          </div>
          <hr>

          <form id="seccion-form" th:action="@{/secciones-plan-ambiental/guardar}" th:object="${seccion}" method="post" novalidate>
            <input type="hidden" th:field="*{codigoSeccion}">

            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label for="numeroSeccion">Numero de la seccion *</label>
                  <input type="number" class="form-control form-control-rounded" id="numeroSeccion"
                         th:field="*{numeroSeccion}" min="1" max="5" step="1" placeholder="Numero de la seccion (1 a 5)" required>
                </div>
              </div>

              <div class="col-md-8">
                <div class="form-group">
                  <label for="tituloSeccion">Titulo de la seccion *</label>
                  <input type="text" class="form-control form-control-rounded" id="tituloSeccion"
                         th:field="*{tituloSeccion}" maxlength="255" placeholder="Titulo de la seccion" required>
                </div>
              </div>

              <div class="col-md-4">
                <div class="form-group">
                  <label for="colorSeccionPicker">Color de la seccion</label>
                  <input type="color" class="form-control form-control-rounded p-1" id="colorSeccionPicker" value="#abb1a9">
                  <input type="hidden" th:field="*{colorSeccion}" id="colorSeccion">
                </div>
              </div>

              <div class="col-md-8">
                <div class="form-group">
                  <label for="fkCodEtapa">Etapa *</label>
                  <select class="form-control form-control-rounded" id="fkCodEtapa"
                          th:field="*{fkCodEtapa}" th:errorclass="is-invalid" required>
                    <option value="">Seleccione una etapa...</option>
                    <option th:each="etapa : ${etapas}"
                            th:value="${etapa.codigoEtapa}"
                            th:text="${etapa.tituloEtapa + (etapa.fkCodPlanAmbiental != null ? ' (Plan #' + etapa.fkCodPlanAmbiental + ')' : '')}">
                    </option>
                  </select>
                  <small class="field-error"
                         th:if="${#fields.hasErrors('fkCodEtapa')}"
                         th:errors="*{fkCodEtapa}"></small>
                </div>
              </div>

              <div class="col-12">
                <div class="form-group">
                  <label for="objetivoSeccion">Objetivo de la seccion *</label>
                  <textarea class="form-control" id="objetivoSeccion" rows="5"
                            th:field="*{objetivoSeccion}" placeholder="Objetivo de la seccion" required></textarea>
                </div>
              </div>

              <div class="col-md-6" th:if="${seccion.fechaCreadoSeccion != null}">
                <div class="form-group">
                  <label>Fecha de creacion</label>
                  <div class="timestamp-box" th:text="${#temporals.format(seccion.fechaCreadoSeccion, 'yyyy-MM-dd HH:mm:ss')}"></div>
                </div>
              </div>

              <div class="col-md-6" th:if="${seccion.fechaEditadoSeccion != null}">
                <div class="form-group">
                  <label>Fecha de ultima edicion</label>
                  <div class="timestamp-box" th:text="${#temporals.format(seccion.fechaEditadoSeccion, 'yyyy-MM-dd HH:mm:ss')}"></div>
                </div>
              </div>

              <div class="col-12">
                <div class="form-group mb-0 actions-wrap">
                  <a class="btn btn-secondary px-5" th:href="@{/secciones-plan-ambiental}">
                    <i class="fa-solid fa-xmark mr-1"></i> Cancelar
                  </a>
                  <button type="submit" class="btn btn-success px-5">
                    <i class="fa-solid fa-floppy-disk mr-1"></i> Guardar
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/localization/messages_es.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var colorPicker = document.getElementById('colorSeccionPicker');
    var colorHidden = document.getElementById('colorSeccion');
    var defaultAlpha = 0.5;

    var hexToRgba = function (hex, alpha) {
      if (!hex) {
        return '';
      }

      var normalized = hex.replace('#', '');
      if (normalized.length === 3) {
        normalized = normalized.split('').map(function (c) {
          return c + c;
        }).join('');
      }

      if (normalized.length !== 6) {
        return '';
      }

      var r = parseInt(normalized.substring(0, 2), 16);
      var g = parseInt(normalized.substring(2, 4), 16);
      var b = parseInt(normalized.substring(4, 6), 16);
      return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
    };

    var rgbaToHex = function (rgba) {
      if (!rgba) {
        return null;
      }

      var match = rgba.match(/rgba?\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})/i);
      if (!match) {
        return null;
      }

      var toHex = function (value) {
        var intValue = Math.max(0, Math.min(255, parseInt(value, 10)));
        return intValue.toString(16).padStart(2, '0');
      };

      return '#' + toHex(match[1]) + toHex(match[2]) + toHex(match[3]);
    };

    var syncColorRgba = function () {
      if (!colorPicker || !colorHidden) {
        return;
      }
      colorHidden.value = hexToRgba(colorPicker.value, defaultAlpha);
    };

    if (colorPicker && colorHidden) {
      if (colorHidden.value) {
        if (colorHidden.value.startsWith('rgba') || colorHidden.value.startsWith('rgb')) {
          var fromRgba = rgbaToHex(colorHidden.value);
          if (fromRgba) {
            colorPicker.value = fromRgba;
          }
        } else if (colorHidden.value.startsWith('#')) {
          colorPicker.value = colorHidden.value;
        }
      }

      syncColorRgba();
      colorPicker.addEventListener('input', syncColorRgba);
      colorPicker.addEventListener('change', syncColorRgba);
    }

    if (window.jQuery && $.fn.validate) {
      var trimValue = function (value) {
        return $.trim(value);
      };

      $('#seccion-form').validate({
        ignore: [],
        rules: {
          numeroSeccion: {
            required: true,
            digits: true,
            min: 1,
            max: 5
          },
          tituloSeccion: {
            required: true,
            minlength: 3,
            maxlength: 255,
            normalizer: trimValue
          },
          objetivoSeccion: {
            required: true,
            minlength: 3,
            normalizer: trimValue
          },
          colorSeccion: {
            maxlength: 25
          },
          fkCodEtapa: {
            required: true
          }
        },
        messages: {
          numeroSeccion: {
            required: 'Ingrese el numero de la seccion',
            digits: 'Ingrese solo numeros',
            min: 'El numero de la seccion debe ser minimo 1',
            max: 'El numero de la seccion debe ser maximo 5'
          },
          tituloSeccion: {
            required: 'Ingrese el titulo de la seccion',
            minlength: 'Minimo 3 caracteres',
            maxlength: 'Maximo 255 caracteres'
          },
          objetivoSeccion: {
            required: 'Ingrese el objetivo de la seccion',
            minlength: 'Minimo 3 caracteres'
          },
          colorSeccion: {
            maxlength: 'Maximo 25 caracteres'
          },
          fkCodEtapa: {
            required: 'Seleccione una etapa'
          }
        },
        errorElement: 'small',
        errorClass: 'field-error',
        errorPlacement: function (error, element) {
          if (element.is('select') && element.next('.nice-select').length) {
            error.insertAfter(element.next('.nice-select'));
            return;
          }

          error.insertAfter(element);
        },
        highlight: function (element) {
          var $element = $(element);
          $element.addClass('is-invalid');

          if ($element.is('select') && $element.next('.nice-select').length) {
            $element.next('.nice-select').addClass('is-invalid');
          }
        },
        unhighlight: function (element) {
          var $element = $(element);
          $element.removeClass('is-invalid');

          if ($element.is('select') && $element.next('.nice-select').length) {
            $element.next('.nice-select').removeClass('is-invalid');
          }
        }
      });
    }
  });
</script>
</body>
</html>
